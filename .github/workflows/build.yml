name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Debug project structure
      run: |
        echo "=== Current directory ==="
        pwd
        echo "=== Project files ==="
        ls -la
        echo "=== Looking for gradle files ==="
        find . -name "*.gradle*" -o -name "gradlew*" 2>/dev/null || echo "No gradle files found"

    - name: Fix Gradle configuration
      run: |
        # 修复settings.gradle以解决仓库冲突
        echo "Fixing Gradle configuration..."
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                gradlePluginPortal()
                google()
                mavenCentral()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "WeChatNotificationInterceptor"
        include ':app'
        EOF

    - name: Initialize Gradle Wrapper
      run: |
        # 使用系统gradle初始化wrapper
        echo "Initializing Gradle wrapper..."
        gradle wrapper --gradle-version=7.6

        # 确保gradlew可执行
        chmod +x gradlew

        # 验证文件
        echo "=== Gradle wrapper files ==="
        ls -la gradle/wrapper/
        ls -la gradlew*

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3

    - name: Build debug APK
      run: ./gradlew assembleDebug --stacktrace

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: wechat-notification-interceptor-debug
        path: app/build/outputs/apk/debug/app-debug.apk
